<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-8268426852108056">
    <title>Analizzatore Numismatico e Filatelico con AI</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8268426852108056"
     crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #privacy-modal {
            transition: opacity 0.3s ease;
        }
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            flex-shrink: 0;
            border-radius: 100%;
            border-width: 2px;
            border-color: #d1d5db;
            height: 1.25rem;
            width: 1.25rem;
        }
        .form-radio:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: #2563eb;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        .lang-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .lang-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .lang-btn:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        .donation-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            background-color: #16a34a; /* Verde */
            transition: background-color 0.2s;
            text-decoration: none;
        }
        .donation-btn:hover {
            background-color: #15803d;
        }
        .uploader-box {
            width: 100%;
            height: 180px; /* Altezza ridotta per i box doppi */
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .uploader-box:hover {
            border-color: #2563eb;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl flex-grow">
        <header class="text-center mb-8">
            <h1 data-key="mainTitle" class="text-4xl sm:text-5xl font-bold text-gray-900">Analizzatore Numismatico e Filatelico</h1>
            <p data-key="mainSubtitle" class="mt-2 text-lg text-gray-600">Carica la foto di una moneta o di un francobollo per ottenere un'analisi AI.</p>
            <div class="mt-6 flex justify-center space-x-2">
                <button id="lang-it" class="lang-btn">IT</button>
                <button id="lang-en" class="lang-btn">EN</button>
            </div>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Sezione di Upload -->
                <div class="flex flex-col items-center justify-center">
                    <!-- Selezione Tipo Analisi -->
                    <div class="flex justify-center space-x-6 mb-6">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="coin" class="form-radio" checked>
                            <span data-key="coinLabel" class="text-gray-700 font-medium">Moneta</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="stamp" class="form-radio">
                            <span data-key="stampLabel" class="text-gray-700 font-medium">Francobollo</span>
                        </label>
                    </div>

                    <!-- Contenitore per gli uploader -->
                    <div id="upload-container" class="w-full">
                        <!-- Uploader per monete (doppio) -->
                        <div id="coin-uploaders" class="grid grid-cols-2 gap-4">
                            <div>
                                <p data-key="frontLabel" class="text-center font-semibold mb-2">Fronte</p>
                                <div id="image-uploader-front" class="uploader-box">
                                    <input type="file" id="file-input-front" class="hidden" accept="image/*">
                                    <div id="upload-prompt-front">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                        <p data-key="uploadClickShort" class="mt-1 text-xs text-blue-600">Carica immagine</p>
                                    </div>
                                    <img id="image-preview-front" src="" alt="Anteprima fronte" class="hidden w-full h-full object-contain rounded-lg">
                                </div>
                            </div>
                            <div>
                                <p data-key="backLabel" class="text-center font-semibold mb-2">Retro</p>
                                <div id="image-uploader-back" class="uploader-box">
                                    <input type="file" id="file-input-back" class="hidden" accept="image/*">
                                    <div id="upload-prompt-back">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                        <p data-key="uploadClickShort" class="mt-1 text-xs text-blue-600">Carica immagine</p>
                                    </div>
                                    <img id="image-preview-back" src="" alt="Anteprima retro" class="hidden w-full h-full object-contain rounded-lg">
                                </div>
                            </div>
                        </div>
                        <!-- Uploader per francobolli (singolo) -->
                        <div id="stamp-uploader" class="hidden w-full">
                             <div class="uploader-box h-64">
                                <input type="file" id="file-input-stamp" class="hidden" accept="image/*">
                                <div id="upload-prompt-stamp">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                    <p class="mt-2 text-sm text-gray-600"><span data-key="uploadClick" class="font-semibold text-blue-600">Clicca per caricare</span> <span data-key="uploadDrag">o trascina un'immagine</span></p>
                                    <p data-key="uploadFormats" class="text-xs text-gray-500">PNG, JPG, GIF fino a 10MB</p>
                                </div>
                                <img id="image-preview-stamp" src="" alt="Anteprima francobollo" class="hidden w-full h-full object-contain rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 w-full flex space-x-4">
                        <button id="analyze-button" data-key="analyzeButton" class="flex-grow bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-transform transform active:scale-95" disabled>
                            Analizza
                        </button>
                        <button id="reset-button" data-key="resetButton" class="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform active:scale-95">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Sezione Risultati -->
                <div id="results-container" class="flex flex-col justify-center">
                    <div id="loader" class="hidden mx-auto loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
                    <div id="results-content" class="hidden space-y-4">
                         <h2 data-key="resultsTitle" class="text-2xl font-bold text-gray-800 border-b pb-2">Risultati dell'Analisi</h2>
                         <div class="card p-5">
                            <h3 data-key="identificationLabel" class="text-lg font-semibold text-gray-700">Identificazione</h3>
                            <p id="identification" class="text-gray-600 mt-1">-</p>
                        </div>
                        <div class="card p-5">
                            <h3 data-key="periodLabel" class="text-lg font-semibold text-gray-700">Periodo/Anno di Emissione</h3>
                            <p id="period" class="text-gray-600 mt-1">-</p>
                        </div>
                        <div class="card p-5">
                            <h3 data-key="valueLabel" class="text-lg font-semibold text-gray-700">Stima di Valore (indicativa)</h3>
                            <p id="value-estimate" class="text-gray-600 mt-1">-</p>
                        </div>
                         <p id="error-message" class="text-red-500 font-medium hidden"></p>
                    </div>
                     <div id="initial-message" class="text-center text-gray-500">
                        <p data-key="initialMessage">I risultati dell'analisi appariranno qui.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="text-center py-8 px-4 text-sm text-gray-500">
        <p data-key="disclaimerText"><strong>Disclaimer:</strong> Le valutazioni sono generate da un'intelligenza artificiale e sono puramente indicative. Per una valutazione accurata, consultare un esperto professionista.</p>
        <div class="mt-4">
            <p data-key="copyrightText" class="font-semibold">© 2025 Nicola Nicolaci. Tutti i diritti riservati.</p>
            <a href="#" id="privacy-link" data-key="privacyLink" class="underline hover:text-blue-600">Privacy Policy</a>
        </div>
        <div class="mt-6">
            <a href="https://buy.stripe.com/6oUbJ3dwZ10U6Ba9lwdjO07" target="_blank" rel="noopener noreferrer" class="donation-btn">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                <span data-key="donationText">Supporta il progetto</span>
            </a>
        </div>
    </footer>

    <!-- Finestra Modale per la Privacy Policy -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-full overflow-y-auto p-6 sm:p-8">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 data-key="privacyTitle" class="text-2xl font-bold text-gray-900">Informativa sulla Privacy</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-4 text-gray-600">
                <p><strong data-key="privacyDateLabel">Data di entrata in vigore:</strong> <span data-key="privacyDate">7 agosto 2025</span></p>
                <p data-key="privacyIntro">La tua privacy è la nostra massima priorità. Questa applicazione è stata progettata per funzionare senza raccogliere, salvare o utilizzare alcuna informazione personale o dato che ti riguarda.</p>
                <h3 data-key="privacyNoDataTitle" class="text-lg font-semibold text-gray-800 pt-2">Nessuna Raccolta Dati</h3>
                <p data-key="privacyNoDataText">Non raccogliamo, tracciamo o memorizziamo alcuna tua informazione personale. Le immagini che carichi vengono elaborate direttamente nel tuo browser e non vengono salvate sui nostri server.</p>
                <h3 data-key="privacyProcessingTitle" class="text-lg font-semibold text-gray-800 pt-2">Elaborazione Sicura e Volatile</h3>
                <p data-key="privacyProcessingText">L'analisi dell'immagine avviene interamente sul tuo dispositivo (lato client). L'immagine viene inviata in modo sicuro ai server di Google esclusivamente per l'analisi da parte del modello di intelligenza artificiale. Questa applicazione non associa l'immagine a te né la memorizza dopo l'analisi.</p>
                <h3 data-key="privacyDeletionTitle" class="text-lg font-semibold text-gray-800 pt-2">Cancellazione Automatica delle Informazioni</h3>
                <p data-key="privacyDeletionText">Tutte le informazioni relative alla tua sessione, inclusa l'immagine caricata e i risultati dell'analisi, esistono solo temporaneamente nella memoria del tuo browser. Chiudendo la pagina del browser o la scheda dell'applicazione, tutti questi dati vengono eliminati in modo permanente e irrecuperabile. Nessuna informazione persiste dopo la chiusura della pagina.</p>
                 <h3 data-key="privacyCookiesTitle" class="text-lg font-semibold text-gray-800 pt-2">Nessun Cookie di Tracciamento</h3>
                <p data-key="privacyCookiesText">Questo sito non utilizza cookie o altre tecnologie simili per tracciare la tua attività di navigazione.</p>
                <p data-key="privacyContact">Per qualsiasi domanda o dubbio riguardo questa informativa, non esitare a contattare il proprietario del sito.</p>
            </div>
        </div>
    </div>


    <script>
        // --- Elementi del DOM ---
        const analyzeButton = document.getElementById('analyze-button');
        const resetButton = document.getElementById('reset-button');
        const loader = document.getElementById('loader');
        const resultsContent = document.getElementById('results-content');
        const initialMessage = document.getElementById('initial-message');
        const identificationEl = document.getElementById('identification');
        const periodEl = document.getElementById('period');
        const valueEstimateEl = document.getElementById('value-estimate');
        const errorMessageEl = document.getElementById('error-message');
        const privacyLink = document.getElementById('privacy-link');
        const privacyModal = document.getElementById('privacy-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const langItBtn = document.getElementById('lang-it');
        const langEnBtn = document.getElementById('lang-en');
        const itemTypeRadios = document.querySelectorAll('input[name="item-type"]');
        const coinUploaders = document.getElementById('coin-uploaders');
        const stampUploader = document.getElementById('stamp-uploader');

        // Uploader Fronte
        const uploaderFront = document.getElementById('image-uploader-front');
        const inputFront = document.getElementById('file-input-front');
        const promptFront = document.getElementById('upload-prompt-front');
        const previewFront = document.getElementById('image-preview-front');
        
        // Uploader Retro
        const uploaderBack = document.getElementById('image-uploader-back');
        const inputBack = document.getElementById('file-input-back');
        const promptBack = document.getElementById('upload-prompt-back');
        const previewBack = document.getElementById('image-preview-back');

        // Uploader Francobollo
        const uploaderStamp = document.getElementById('stamp-uploader').querySelector('.uploader-box');
        const inputStamp = document.getElementById('file-input-stamp');
        const promptStamp = document.getElementById('upload-prompt-stamp');
        const previewStamp = document.getElementById('image-preview-stamp');

        let base64ImageDataFront = null;
        let base64ImageDataBack = null;
        let currentLanguage = 'it';

        // --- Oggetto Traduzioni ---
        const translations = {
            it: {
                mainTitle: "Analizzatore Numismatico e Filatelico",
                mainSubtitle: "Carica la foto di una moneta o di un francobollo per ottenere un'analisi AI.",
                coinLabel: "Moneta",
                stampLabel: "Francobollo",
                frontLabel: "Fronte",
                backLabel: "Retro",
                uploadClick: "Clicca per caricare",
                uploadDrag: "o trascina un'immagine",
                uploadClickShort: "Carica immagine",
                uploadFormats: "PNG, JPG, GIF fino a 10MB",
                analyzeButton: "Analizza",
                resetButton: "Reset",
                resultsTitle: "Risultati dell'Analisi",
                identificationLabel: "Identificazione",
                periodLabel: "Periodo/Anno di Emissione",
                valueLabel: "Stima di Valore (indicativa)",
                initialMessage: "I risultati dell'analisi appariranno qui.",
                disclaimerText: "<strong>Disclaimer:</strong> Le valutazioni sono generate da un'intelligenza artificiale e sono puramente indicative. Per una valutazione accurata, consultare un esperto professionista.",
                copyrightText: "© 2025 Nicola Nicolaci. Tutti i diritti riservati.",
                privacyLink: "Privacy Policy",
                donationText: "Supporta il progetto",
                privacyTitle: "Informativa sulla Privacy",
                privacyDateLabel: "Data di entrata in vigore:",
                privacyDate: "7 agosto 2025",
                privacyIntro: "La tua privacy è la nostra massima priorità...",
                privacyNoDataTitle: "Nessuna Raccolta Dati",
                privacyNoDataText: "Non raccogliamo, tracciamo o memorizziamo...",
                privacyProcessingTitle: "Elaborazione Sicura e Volatile",
                privacyProcessingText: "L'analisi dell'immagine avviene interamente...",
                privacyDeletionTitle: "Cancellazione Automatica delle Informazioni",
                privacyDeletionText: "Tutte le informazioni relative alla tua sessione...",
                privacyCookiesTitle: "Nessun Cookie di Tracciamento",
                privacyCookiesText: "Questo sito non utilizza cookie...",
                privacyContact: "Per qualsiasi domanda o dubbio..."
            },
            en: {
                mainTitle: "Numismatic and Philatelic Analyzer",
                mainSubtitle: "Upload a photo of a coin or stamp to get an AI analysis.",
                coinLabel: "Coin",
                stampLabel: "Stamp",
                frontLabel: "Front",
                backLabel: "Back",
                uploadClick: "Click to upload",
                uploadDrag: "or drag and drop",
                uploadClickShort: "Upload image",
                uploadFormats: "PNG, JPG, GIF up to 10MB",
                analyzeButton: "Analyze",
                resetButton: "Reset",
                resultsTitle: "Analysis Results",
                identificationLabel: "Identification",
                periodLabel: "Period/Year of Issue",
                valueLabel: "Value Estimate (indicative)",
                initialMessage: "The analysis results will appear here.",
                disclaimerText: "<strong>Disclaimer:</strong> Valuations are generated by an AI and are purely indicative. For an accurate valuation, please consult a professional expert.",
                copyrightText: "© 2025 Nicola Nicolaci. All rights reserved.",
                privacyLink: "Privacy Policy",
                donationText: "Support the project",
                privacyTitle: "Privacy Policy",
                privacyDateLabel: "Effective date:",
                privacyDate: "August 7, 2025",
                privacyIntro: "Your privacy is our top priority...",
                privacyNoDataTitle: "No Data Collection",
                privacyNoDataText: "We do not collect, track, or store...",
                privacyProcessingTitle: "Secure and Volatile Processing",
                privacyProcessingText: "The image analysis occurs entirely...",
                privacyDeletionTitle: "Automatic Information Deletion",
                privacyDeletionText: "All information related to your session...",
                privacyCookiesTitle: "No Tracking Cookies",
                privacyCookiesText: "This site does not use cookies...",
                privacyContact: "For any questions or concerns..."
            }
        };

        // --- Funzioni Principali ---

        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            langItBtn.classList.toggle('active', lang === 'it');
            langEnBtn.classList.toggle('active', lang === 'en');
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (translations[lang] && translations[lang][key]) {
                    element.innerHTML = translations[lang][key];
                }
            });
        }
        
        function handleFile(file, type) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    if (type === 'front') {
                        previewFront.src = e.target.result;
                        previewFront.classList.remove('hidden');
                        promptFront.classList.add('hidden');
                        base64ImageDataFront = base64Data;
                    } else if (type === 'back') {
                        previewBack.src = e.target.result;
                        previewBack.classList.remove('hidden');
                        promptBack.classList.add('hidden');
                        base64ImageDataBack = base64Data;
                    } else if (type === 'stamp') {
                        previewStamp.src = e.target.result;
                        previewStamp.classList.remove('hidden');
                        promptStamp.classList.add('hidden');
                        base64ImageDataFront = base64Data; // Per i francobolli usiamo la variabile 'front'
                        base64ImageDataBack = null;
                    }
                    checkAnalyzeButtonState();
                };
                reader.readAsDataURL(file);
            } else {
                alert("Per favore, seleziona un file immagine valido.");
            }
        }

        function toggleUploaderView(itemType) {
            if (itemType === 'coin') {
                coinUploaders.classList.remove('hidden');
                stampUploader.classList.add('hidden');
            } else {
                coinUploaders.classList.add('hidden');
                stampUploader.classList.remove('hidden');
            }
            resetApp();
        }

        function checkAnalyzeButtonState() {
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            if (itemType === 'coin') {
                // Abilita se almeno una delle due facce è caricata
                analyzeButton.disabled = !(base64ImageDataFront || base64ImageDataBack);
            } else { // stamp
                analyzeButton.disabled = !base64ImageDataFront;
            }
        }

        function resetApp() {
            // Reset Dati
            base64ImageDataFront = null;
            base64ImageDataBack = null;

            // Reset UI Uploader
            previewFront.src = '';
            previewBack.src = '';
            previewStamp.src = '';
            previewFront.classList.add('hidden');
            previewBack.classList.add('hidden');
            previewStamp.classList.add('hidden');
            promptFront.classList.remove('hidden');
            promptBack.classList.remove('hidden');
            promptStamp.classList.remove('hidden');
            
            // Reset Risultati
            resultsContent.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            identificationEl.textContent = '-';
            periodEl.textContent = '-';
            valueEstimateEl.textContent = '-';
            
            // Reset Pulsanti
            analyzeButton.disabled = true;

            // Reset input file per permettere di ricaricare lo stesso file
            inputFront.value = '';
            inputBack.value = '';
            inputStamp.value = '';
        }

        // --- Event Listeners ---

        langItBtn.addEventListener('click', () => setLanguage('it'));
        langEnBtn.addEventListener('click', () => setLanguage('en'));

        itemTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => toggleUploaderView(e.target.value));
        });

        privacyLink.addEventListener('click', (e) => {
            e.preventDefault();
            privacyModal.classList.remove('hidden');
        });
        closeModalButton.addEventListener('click', () => {
            privacyModal.classList.add('hidden');
        });
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) {
                privacyModal.classList.add('hidden');
            }
        });

        uploaderFront.addEventListener('click', () => inputFront.click());
        inputFront.addEventListener('change', (e) => handleFile(e.target.files[0], 'front'));
        
        uploaderBack.addEventListener('click', () => inputBack.click());
        inputBack.addEventListener('change', (e) => handleFile(e.target.files[0], 'back'));

        uploaderStamp.addEventListener('click', () => inputStamp.click());
        inputStamp.addEventListener('change', (e) => handleFile(e.target.files[0], 'stamp'));

        resetButton.addEventListener('click', resetApp);

        analyzeButton.addEventListener('click', async () => {
            showLoading(true);
            errorMessageEl.classList.add('hidden');
            
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            
            const prompts = {
                it: {
                    coin_two_sides: `Sei un esperto di numismatica di fama mondiale. Analizza le due immagini di questa moneta (fronte e retro) e fornisci una risposta unica e completa in formato JSON con le chiavi "identificazione", "periodo", e "stima_valore". La tua risposta deve essere in italiano. - "identificazione": Descrizione dettagliata. - "periodo": Anno o secolo. - "stima_valore": Stima approssimativa in Euro.`,
                    coin_one_side: `Sei un esperto di numismatica di fama mondiale. Analizza questa singola immagine di una faccia di una moneta. Fai del tuo meglio per identificarla e fornisci una risposta in formato JSON con le chiavi "identificazione", "periodo", e "stima_valore". Specifica nel campo "identificazione" che l'analisi è basata su una sola faccia e potrebbe essere incompleta. La tua risposta deve essere in italiano.`,
                    stamp: `Sei un esperto di filatelia di fama mondiale. Analizza l'immagine di questo francobollo e fornisci le seguenti informazioni in un formato JSON...`
                },
                en: {
                    coin_two_sides: `You are a world-renowned numismatics expert. Analyze the two images of this coin (front and back) and provide a single, comprehensive response in JSON format with the keys "identification", "period", and "value_estimate". Your response must be in English. - "identification": Detailed description. - "period": Year or century. - "value_estimate": Approximate estimate in Euros.`,
                    coin_one_side: `You are a world-renowned numismatics expert. Analyze this single image of one side of a coin. Do your best to identify it and provide a response in JSON format with the keys "identification", "period", and "value_estimate". Specify in the "identification" field that the analysis is based on only one side and may be incomplete. Your response must be in English.`,
                    stamp: `You are a world-renowned philately expert. Analyze the image of this stamp and provide the following information in a JSON format...`
                }
            };

            let prompt;
            if (itemType === 'coin') {
                prompt = (base64ImageDataFront && base64ImageDataBack) ? prompts[currentLanguage].coin_two_sides : prompts[currentLanguage].coin_one_side;
            } else {
                prompt = prompts[currentLanguage].stamp;
            }

            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base64ImageDataFront: base64ImageDataFront,
                        base64ImageDataBack: base64ImageDataBack,
                        prompt: prompt 
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Errore HTTP: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    const text = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(text);
                    displayResults(parsedJson);
                } else {
                    showError("La risposta dell'API non è valida o è vuota. Riprova.");
                }

            } catch (error) {
                showError(`Si è verificato un errore: ${error.message}. Riprova.`);
            } finally {
                showLoading(false);
            }
        });
        
        // --- Funzioni di Utilità UI ---
        function showLoading(isLoading) {
            loader.classList.toggle('hidden', !isLoading);
            initialMessage.classList.add('hidden');
            if(isLoading) {
                 resultsContent.classList.add('hidden');
            }
            analyzeButton.disabled = isLoading;
        }

        function displayResults(data) {
            identificationEl.textContent = data.identificazione || data.identification || 'Non disponibile';
            periodEl.textContent = data.periodo || data.period || 'Non disponibile';
            valueEstimateEl.textContent = data.stima_valore || data.value_estimate || 'Non disponibile';
            resultsContent.classList.remove('hidden');
        }

        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            resultsContent.classList.remove('hidden'); 
            identificationEl.textContent = '-';
            periodEl.textContent = '-';
            valueEstimateEl.textContent = '-';
        }

        // --- Inizializzazione ---
        setLanguage('it');
        toggleUploaderView('coin'); // Mostra l'uploader per monete all'inizio
    </script>
</body>
</html>
